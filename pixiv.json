[
    {
        "bookSourceComment": "Pixiv ä¹¦æºï¼ˆæ›´æ–°æ—¶é—´ï¼š2024-06-12ï¼‰\n\nå¯ç”¨åŠŸèƒ½ï¼šâœ…æœç´¢âœ…å‘ç°âœ…æ·»åŠ é“¾æ¥âœ…è®¢é˜…æº\næœç´¢å°è¯´ï¼šâœ…å°è¯´åç§°âœ…ä½œè€…åç§°âœ…å°è¯´æ ‡ç­¾\nå‘ç°å°è¯´ï¼šâœ…å…³æ³¨ä½œè€…âŒè¿½æ›´åˆ—è¡¨âœ…æ¨èå°è¯´âœ…æ”¶è—å°è¯´\næ·»åŠ ç½‘å€ï¼šâœ…Pixivå°è¯´é“¾æ¥âœ…Pixivç³»åˆ—å°è¯´é“¾æ¥\nè®¢é˜…ç”¨æ³•ï¼šç‚¹å‡»è®¢é˜…æºæ‰“å¼€å°è¯´/ç³»åˆ—å°è¯´ï¼Œã€åˆ·æ–°ã€‘ï¼Œç‚¹å‡»ã€åŠ å…¥ä¹¦æ¶ã€‘æŒ‰é’®æ·»åŠ å°è¯´åˆ°ä¹¦æ¶\n\nä¹¦æºå‘å¸ƒï¼šå…½äººé˜…è¯»é¢‘é“ https://t.me/FurryReading\né¡¹ç›®åœ°å€ï¼šhttps://github.com/windyhusky/PixivSource\nè§„åˆ™è®¢é˜…ï¼šhttps://cdn.jsdelivr.net/gh/windyhusky/PixivSource@main/pixiv.json\nhttps://raw.githubusercontent.com/windyhusky/PixivSource/main/pixiv.json",
        "bookSourceGroup": "ğŸ” Pixiv",
        "bookSourceName": "Pixiv",
        "bookSourceType": 0,
        "bookSourceUrl": "https://www.pixiv.net",
        "bookUrlPattern": "(https?://)?(www.)?pixiv.net/novel/.*",
        "customOrder": 0,
        "enabled": false,
        "enabledCookieJar": false,
        "enabledExplore": true,
        "exploreUrl": "[\n  {\n    \"title\": \"å…³æ³¨ä½œè€…\",\n    \"url\": \"https://www.pixiv.net/ajax/follow_latest/novel?p={{page}}&mode=all&lang=zh\",\n    \"style\": {\n      \"layout_flexGrow\": 1,\n      \"layout_flexBasisPercent\":0.3\n    }\n  },\n    {\n    \"title\": \"è¿½æ›´åˆ—è¡¨(æœªå®Œæˆ)\",\n    \"url\": \"https://www.pixiv.net/ajax/watch_list/novel?p={{page}}&new=1&lang=zh\",\n    \"style\": {\n      \"layout_flexGrow\": 1,\n      \"layout_flexBasisPercent\":0.3\n    }\n  },\n  {\n    \"title\": \"æ¨èå°è¯´\",\n    \"url\": \"https://www.pixiv.net/ajax/top/novel?mode=all&lang=zh\",\n    \"style\": {\n      \"layout_flexGrow\": 1,\n      \"layout_flexBasisPercent\":0.3\n    }\n  },\n  {\n    \"title\": \"æ”¶è—å°è¯´\",\n    \"url\": \"https://www.pixiv.net/ajax/user/{{cache.get(\\\"pixiv:uid\\\")}}/novels/bookmarks?tag=&offset={{(page-1)*24}}&limit=24&rest=show&lang=zh\",\n    \"style\": {\n      \"layout_flexGrow\": 1,\n      \"layout_flexBasisPercent\":0.3\n    }\n  }\n]",
        "header": "{\"referer\":\"https://www.pixiv.net\"}",
        "lastUpdateTime": 1718177794470,
        "loginCheckJs": "var util = {}\n\nfunction objStringify(obj) {\n    return JSON.stringify(obj, (n, v) => {\n        if (typeof v == \"function\")\n            return v.toString();\n        return v;\n    });\n}\n\nfunction publicFunc() {\n    let u = {}\n\n    u.cacheGetAndSet = (key, supplyFunc) => {\n        let v = cache.get(key)\n        if (v === undefined || v === null) {\n            v = JSON.stringify(supplyFunc())\n            // ç¼“å­˜10åˆ†é’Ÿ\n            cache.put(key, v, 600)\n        }\n        return JSON.parse(v)\n    }\n    u.getAjaxJson = (url) => {\n        return util.cacheGetAndSet(url, () => {\n            return JSON.parse(java.ajax(url))\n        })\n    }\n    u.getWebviewJson = (url, parseFunc) => {\n        return util.cacheGetAndSet(url, () => {\n            let html = java.webView(null, url, null)\n            return JSON.parse(parseFunc(html))\n        })\n    }\n    u.debugFunc = (func) => {\n        if (String(source.getVariable()) === \"debug\") {\n            func()\n        }\n    }\n\n    u.urlNovelDetailed = (nid) => {\n        return `https://www.pixiv.net/ajax/novel/${nid}`\n    }\n    u.urlSeries = (seriesId) => {\n        return `https://www.pixiv.net/ajax/novel/series/${seriesId}?lang=zh`\n    }\n    u.urlSeriesNovels = (seriesId, limit, offset) => {\n        if (limit > 30) {\n            limit = 30\n        }\n\n        if (limit < 10) {\n            limit = 10\n        }\n\n        return `https://www.pixiv.net/ajax/novel/series_content/${seriesId}?limit=${limit}&last_order=${offset}&order_by=asc&lang=zh`\n    }\n    u.searchNovel = (novelName, page) =>{\n        return `https://www.pixiv.net/ajax/search/novels/${encodeURI(novelName)}?word=${encodeURI(novelName)}&order=date_d&mode=all&p=${page}&s_mode=s_tag&lang=zh`\n    }\n    // å®Œå…¨åŒ¹é…ç”¨æˆ·å\n    u.urlSearchUser = (username) => {\n        return `https://www.pixiv.net/search_user.php?s_mode=s_usr&nick=${encodeURI(username)}&nick_mf=1`\n    }\n    u.urlUserAllWorks = (uid) => {\n        return `https://www.pixiv.net/ajax/user/${uid}/profile/all?lang=zh`\n    }\n    u.urlUserNovels = (uid, nidList) => {\n        return `https://www.pixiv.net/ajax/user/${uid}/novels?${nidList.map(v => \"ids[]=\" + v).join(\"&\")}`\n    }\n\n    u.urlIllustDetailed = (illustId) => {\n        return `https://www.pixiv.net/ajax/illust/${illustId}?lang=zh`\n    }\n    u.urlSeriesIllusts = (seriesId) => {\n        return `https://www.pixiv.net/ajax/series/${seriesId}?p=1&lang=zh`\n    }\n    u.urlCoverUrl = (url) => {\n        return `${url},{\"headers\": {\"Referer\":\"https://www.pixiv.net/\"}}`\n    }\n\n    u.formatNovels = function (novels) {\n        novels.forEach(novel => {\n            novel.detailedUrl = util.urlNovelDetailed(novel.id)\n            const time = this.dateFormat(novel.updateDate);\n            novel.tags = novel.tags.join(\",\")\n            novel.coverUrl = util.urlCoverUrl(novel.url)\n            novel.description += `\\næ›´æ–°æ—¶é—´:${time}`\n        })\n        return novels\n    }\n\n    u.dateFormat = function (str) {\n        let addZero = function (num) {\n            return num < 10 ? '0' + num : num;\n        }\n\n        let time = new Date(str);\n\n        let Y = time.getFullYear() + \"å¹´\";\n        let M = addZero(time.getMonth() + 1) + \"æœˆ\";\n        let D = addZero(time.getDate()) + \"æ—¥\";\n        // let h = addZero(time.getHours()) + \"æ—¶\";\n        // let m = addZero(time.getMinutes()) + \"åˆ†\";\n\n        // return Y + M + D + h + m;\n        return Y + M + D;\n    }\n\n\n    util = u\n    java.put(\"util\", objStringify(u))\n}\n\npublicFunc()\n\n// è·å–è¯·æ±‚çš„user idæ–¹ä¾¿å…¶ä»–ajaxè¯·æ±‚æ„é€ \nlet uid = java.getResponse().headers().get(\"x-userid\")\nif (uid != null) {\n    cache.put(\"pixiv:uid\", uid)\n}\njava.getStrResponse(null, null)",
        "loginUrl": "https://accounts.pixiv.net/login",
        "respondTime": 180000,
        "ruleBookInfo": {
            "author": "author",
            "coverUrl": "coverUrl",
            "init": "@js:\n\nvar util = objParse(String(java.get(\"util\")))\n\nfunction objParse(obj) {\n    return JSON.parse(obj, (n, v) => {\n        if (typeof v == \"string\" && v.match(\"()\")) {\n            return eval(`(${v})`)\n        }\n        return v;\n    })\n}\n\n(function (res) {\n    // è·å–ç½‘å€idï¼Œè¯·æ±‚å¹¶è§£ææ•°æ®\n    let isHtml = result.startsWith(\"<!DOCTYPE html>\")\n    if (isHtml) {\n        var novelId = 0\n        let isSeries = baseUrl.match(new RegExp(\"pixiv.net/novel/series\"))\n        if (isSeries) {\n            let seriesId = baseUrl.match(new RegExp(\"\\\\d+\"))[0]\n            java.log(`ç³»åˆ—IDï¼š${seriesId}`)\n            // è·å–ç³»åˆ—ç¬¬ä¸€ç¯‡å°è¯´çš„ id\n            let url = util.urlSeriesNovels(seriesId, 30, 0)\n            res = util.cacheGetAndSet(url, () => {\n                return JSON.parse(java.ajax(url))\n            })\n            novelId = res.body.thumbnails.novel[0].id\n            java.log(`å°è¯´IDï¼š${novelId}`)\n            res = util.getAjaxJson(util.urlNovelDetailed(novelId)).body\n            // java.log(JSON.stringify(res))\n        } else {\n            let isNovel = baseUrl.match(new RegExp(\"pixiv.net/novel\"))\n            if (isNovel) {\n                novelId = baseUrl.match(new RegExp(\"\\\\d+\"))[0]\n                java.log(`å°è¯´IDï¼š${novelId}`)\n                res = util.getAjaxJson(util.urlNovelDetailed(novelId)).body\n                // java.log(JSON.stringify(res))\n            } else {\n                return []\n            }\n        }\n    } else {\n        // ä»æœç´¢ç›´æ¥è·å– json\n        res = JSON.parse(result).body\njava.log(JSON.stringify(res))\n        if (res.total === 0) {\n            return []\n        }\n    }\n\n    let info = {}\n    info.author = res.userName\n    info.name = res.title\n    // info.tags = []\n    // info.tags = res.tags.tags\n    info.wordCount = res.wordCount\n    info.latestChapter = null\n    info.desc = res.description\n    info.coverUrl = res.coverUrl\n    info.catalogUrl = util.urlNovelDetailed(res.id)\n\n    if (res.seriesNavData === undefined || res.seriesNavData === null) {\n        info.name = res.title\n        info.catalog = util.urlNovelDetailed(res.id)\n        // res.tags.unshift('å•æœ¬')\n    } else {\n        info.name = res.seriesNavData.title\n        info.catalog = util.urlSeries(res.seriesNavData.id)\n        // res.tags.unshift('é•¿ç¯‡')\n    }\n    // info.classes = res.tags.join(\",\")\n\n    return info\n})();",
            "intro": "desc",
            "kind": "tags",
            "name": "name",
            "tocUrl": "catalogUrl",
            "wordCount": "wordCount"
        },
        "ruleContent": {
            "content": "@js:\n\nvar util = objParse(String(java.get(\"util\")))\n\nfunction objParse(obj) {\n    return JSON.parse(obj, (n, v) => {\n        if (typeof v == \"string\" && v.match(\"()\")) {\n            return eval(`(${v})`)\n        }\n        return v;\n    })\n}\n\n(() => {\n    let res = JSON.parse(result).body\n    let content = res.content\n    // åœ¨æ­£æ–‡å†…éƒ¨æ·»åŠ å°è¯´æè¿°\n    if (res.seriesNavData !== undefined && res.seriesNavData !== null && res.description !== \"\") {\n        content = res.description + \"\\n\" + \"â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\\n\".repeat(2) + content\n    }\n\n    // è·å– [uploadedimage:] çš„å›¾ç‰‡é“¾æ¥\n    let hasEmbeddedImages = res.textEmbeddedImages !== undefined && res.textEmbeddedImages !== null\n    if (hasEmbeddedImages) {\n        Object.keys(res.textEmbeddedImages).forEach((key) => {\n            // ä¸å†ä½¿ç”¨ linpx æœåŠ¡åŠ è½½å›¾ç‰‡\n            // content = content.replace(`[uploadedimage:${key}]`, `<img src=\"https://api.furrynovel.ink/proxy/pximg?url=${res.textEmbeddedImages[key].urls.original}\">`)\n            content = content.replace(`[uploadedimage:${key}]`, `<img src=\"${res.textEmbeddedImages[key].urls.original}\">`)\n\n        })\n    }\n\n    // // è·å– [pixivimage:] çš„å›¾ç‰‡é“¾æ¥\n    let rex = /\\[pixivimage:(\\d+)]/gm\n    let matched = content.match(RegExp(rex))\n    if (matched) {\n        for (let i in matched) {\n            let illustId = matched[i].match(RegExp(\"\\\\d+\"))\n            let res2 = util.getAjaxJson(util.urlIllustDetailed(illustId)).body\n            let illustOriginal = res2.urls.original\n            content = content.replace(`${matched[i]}`, `<img src=\"${illustOriginal}\">`)\n        }\n    }\n\n\n    // æ›¿æ¢ Pixiv ç« èŠ‚æ ‡è®°ç¬¦å· [newpage] [chapter:]\n    content = content.replace(`[newpage]`, ``)\n    matched = content.match(RegExp(/\\[chapter:(.*?)]/gm))\n    if (matched) {\n        for (let i in matched) {\n            let matched2 = matched[i].match(/\\[chapter:(.*?)]/m)\n            let chapter = matched2[1].trim()\n            // ç« èŠ‚ç¼–å·\n            // if ((chapter.includes(\"ç¬¬\"))||(chapter.includes(\"ç« \"))){\n            //     // chapter = `${chapter}`\n            // } else {\n            //     chapter = `ç¬¬${Number(i)+1}èŠ‚ ${chapter}`\n            // }\n            content = content.replace(`${matched[i]}`, `${\"<p>â€‹<p/>\".repeat(3)}${chapter}<p>â€‹<p/>`)\n        }\n    }\n\n    // æ›¿æ¢ Pixiv è·³è½¬é¡µé¢æ ‡è®°ç¬¦å· [[jump:]]\n    matched = content.match(/\\[jump:(\\d+)]/gm)\n    if (matched) {\n        for (let i in matched) {\n            let page = matched[i].match(/\\d+/)\n            content = content.replace(`${matched[i]}`, `\\n\\nè·³è½¬è‡³ç¬¬${page}èŠ‚`)\n        }\n    }\n\n    // æ›¿æ¢ Pixiv é“¾æ¥æ ‡è®°ç¬¦å· [[jumpuri: > ]]\n    matched = content.match(/\\[\\[jumpuri:(.*?)>(.*?)]]/gm)\n    if (matched) {\n        for (let i in matched) {\n            let matched2 = matched[i].match(/\\[\\[jumpuri:(.*?)>(.*?)]]/m)\n            let matchedText = matched2[0]\n            let urlName = matched2[1].trim()\n            let urlLink = matched2[2].trim()\n            // é˜…è¯»ä¸æ”¯æŒè¶…é“¾æ¥\n            //content = content.replace(`${matchedText}`, `<a href=${urlLink}>${urlName}</a>`)\n            if (urlLink === urlName) {\n                content = content.replace(`${matchedText}`, `${urlName}`)\n            } else {\n                content = content.replace(`${matchedText}`, `${urlName}: ${urlLink}`)\n            }\n        }\n    }\n\n    // æ›¿æ¢ Pixiv æ³¨éŸ³æ ‡è®°ç¬¦å· [[rb: > ]]\n    matched = content.match(/\\[\\[rb:(.*?)>(.*?)]]/gm)\n    if (matched) {\n        for (let i in matched) {\n            let matched2 = matched[i].match(/\\[\\[rb:(.*?)>(.*?)]]/m)\n            let matchedText = matched2[0]\n            let kanji = matched2[1].trim()\n            let kana = matched2[2].trim()\n            // kanaä¸ºä¸­æ–‡ï¼Œåˆ™æ›¿æ¢å›ã€Šä¹¦åå·ã€‹\n            var reg = new RegExp(\"[\\\\u4E00-\\\\u9FFF]+\",\"g\");\n            if (reg.test(kana)) {\n                content = content.replace(`${matchedText}`, `${kanji}ã€Š${kana}ã€‹`)\n            } else{\n                // é˜…è¯»ä¸æ”¯æŒ <ruby> <rt> æ³¨éŸ³\n                // content = content.replace(`${matchedText}`, `<ruby>${kanji}<rt>${kana}</rt></ruby>`)\n                content = content.replace(`${matchedText}`, `${kanji}ï¼ˆ${kana}ï¼‰`)\n            }\n        }\n    }\n\n    return content\n})()\n",
            "imageStyle": "DEFAULT",
            "nextContentUrl": "",
            "title": ""
        },
        "ruleExplore": {
            "author": "userName",
            "bookList": "@js:\nvar util = objParse(String(java.get(\"util\")))\n\nfunction objParse(obj) {\n    return JSON.parse(obj, (n, v) => {\n        if (typeof v == \"string\" && v.match(\"()\")) {\n            return eval(`(${v})`)\n        }\n        return v;\n    })\n}\n\n\n// å­˜å‚¨seriesID æœ‰BUGæ— æ³•å¤„ç†ç¿»é¡µ\nvar seriesSet = new Set();\n// å°†å¤šä¸ªé•¿ç¯‡å°è¯´è§£æä¸ºä¸€æœ¬ä¹¦\nfunction combineNovels(novels) {\n    return novels.filter(novel => {\n        //å•æœ¬ç›´æ¥è§£æä¸ºä¸€æœ¬ä¹¦\n        if (novel.seriesId === undefined || novel.seriesId === null) {\n            return true\n        }\n\n        //é›†åˆä¸­æ²¡æœ‰è¯¥ç³»åˆ—è§£æä¸ºä¸€æœ¬ä¹¦\n        if (!seriesSet.has(novel.seriesId)) {\n            seriesSet.add(novel.seriesId)\n            return true\n        }\n\n        return false\n    })\n}\n\nfunction handNovels(novels) {\n    novels.forEach(novel => {\n        if (novel.tags === undefined || novel.tags === null) {\n            novel.tags = []\n        }\n\n        if (novel.seriesId === undefined || novel.seriesId === null) {\n            novel.tags.unshift(\"å•æœ¬\")\n        } else {\n            let userAllWorks = util.getAjaxJson(util.urlUserAllWorks(novel.userId)).body\n            for (let series of userAllWorks.novelSeries) {\n                if (series.id === novel.seriesId) {\n                    // let series = util.getAjaxJson(util.urlSeries(novel.seriesId)).body\n                    novel.textCount = series.publishedTotalCharacterCount\n                    novel.url = series.cover.urls[\"480mw\"]\n                    novel.title = series.title\n                    novel.tags = series.tags\n                    novel.description = series.caption\n\n                    try{\n                        // å‘é€è¯·æ±‚è·å–ç¬¬ä¸€ç«  è·å–æ ‡ç­¾ä¸ç®€ä»‹\n                        if (novel.tags.length === 0 || novel.description === \"\") {\n                            let firstNovel = util.getAjaxJson(util.urlNovelDetailed(series.firstNovelId)).body\n                            if (novel.tags.length === 0) {\n                                novel.tags = firstNovel.tags.tags.map(item => item.tag)\n                            }\n\n                            if (novel.description === \"\") {\n                                novel.description = firstNovel.description\n                            }\n                        }\n                        novel.tags.unshift(\"é•¿ç¯‡\")\n                        break\n                    } catch (e) {\n                        java.log(e)\n                    }\n                }\n            }\n        }\n    })\n    return novels\n}\n\nfunction handlerFactory() {\n    let cookie = String(java.getCookie(\"https://www.pixiv.net/\", null))\n    if (cookie === null || cookie === undefined || cookie === \"\") {\n        return handlerNoLogin()\n    }\n    if (baseUrl.indexOf(\"/bookmark\") !== -1) {\n        return handlerBookMarks()\n    }\n\n    if (baseUrl.indexOf(\"/top\") !== -1) {\n        return handlerRecommend()\n    }\n\n    if (baseUrl.indexOf(\"/following\") !== -1) {\n        return handlerFollowing()\n    }\n\n    if (baseUrl.indexOf(\"/follow_latest\") !== -1) {\n        return handlerFollowLatest()\n    }\n}\n\nfunction handlerFollowing() {\n    return () => {\n        let novelList = []\n        JSON.parse(result).body.users\n            .filter(user => user.novels.length > 0)\n            .map(user => user.novels)\n            .forEach(novels => {\n                return novels.forEach(novel => {\n                    novelList.push(novel)\n                })\n            })\n        return util.formatNovels(handNovels(novelList))\n    }\n}\n\nfunction handlerRecommend() {\n    return () => {\n        let res = JSON.parse(result)\n        const recommend = res.body.page.recommend\n        const novels = res.body.thumbnails.novel\n        let nidSet = new Set(recommend.ids)\n        // java.log(nidSet.size)\n        let list = novels.filter(novel => nidSet.has(String(novel.id)))\n        // java.log(`è¿‡æ»¤ç»“æœ:${JSON.stringify(list)}`)\n        return util.formatNovels(handNovels(combineNovels(list)))\n    }\n}\n\nfunction handlerNoLogin() {\n    return () => {\n        java.longToast(\"æ­¤åŠŸèƒ½éœ€è¦åœ¨ä¹¦æºç™»å½•åæ‰èƒ½ä½¿ç”¨\")\n        return []\n    }\n}\n\nfunction handlerBookMarks() {\n    return () => {\n        let resp = JSON.parse(result).body.works\n        if (resp === undefined || resp.length === 0) {\n            //æµç¨‹æ— æ³•æœ¬ç¯èŠ‚ä¸­æ­¢ åªèƒ½äº¤ç»™ä¸‹ä¸€æµç¨‹å¤„ç†\n            return []\n        }\n\n        return util.formatNovels(handNovels(resp))\n    }\n}\n\nfunction handlerFollowLatest() {\n    return () => {\n        let resp = JSON.parse(result)\n        return util.formatNovels(handNovels(combineNovels(resp.body.thumbnails.novel)))\n    }\n}\n\n\n(() => {\n    return handlerFactory()()\n})()",
            "bookUrl": "detailedUrl",
            "coverUrl": "coverUrl",
            "intro": "description",
            "kind": "tags",
            "lastChapter": "latestChapter",
            "name": "title",
            "wordCount": "textCount"
        },
        "ruleReview": {},
        "ruleSearch": {
            "author": "userName",
            "bookList": "@js:\nvar util = objParse(String(java.get(\"util\")))\n\nfunction objParse(obj) {\n    return JSON.parse(obj, (n, v) => {\n        if (typeof v == \"string\" && v.match(\"()\")) {\n            return eval(`(${v})`)\n        }\n        return v;\n    })\n}\n\n//ä¸å¯ä½¿ç”¨ base å†…çš„ util.getAjaxJson() æ›¿æ¢\nfunction getAjaxJson(url) {\n    return util.cacheGetAndSet(url, () => {\n        return JSON.parse(java.ajax(url))\n    })\n}\n\nfunction getWebviewJson(url, parseFunc) {\n    return util.cacheGetAndSet(url, () => {\n        let html = java.webView(null, url, null)\n        return JSON.parse(parseFunc(html))\n    })\n}\n\nvar first = true;\n// å­˜å‚¨seriesIDÂ·\nvar seriesSet = {\n    keywords: \"Pixiv:Search\",\n    has: (value) => {\n        let page = Number(java.get(\"page\"))\n        if (page === 1 && first) {\n            first = false\n            cache.deleteMemory(this.keywords)\n            return false\n        }\n\n        let v = cache.getFromMemory(this.keywords)\n        if (v === undefined || v === null) {\n            return false\n        }\n        let set = new Set(JSON.parse(v))\n        return set.has(value)\n    },\n\n    add: (value) => {\n        let v = cache.getFromMemory(this.keywords)\n        if (v === undefined || v === null) {\n            cache.putMemory(this.keywords, JSON.stringify([value]))\n\n        } else {\n            let arr = JSON.parse(v)\n            if (typeof arr === \"string\") {\n                arr = Array(arr)\n            }\n            arr.push(value)\n            cache.putMemory(this.keywords, JSON.stringify(arr))\n        }\n    },\n};\n\n// å°†å¤šä¸ªé•¿ç¯‡å°è¯´è§£æä¸ºä¸€æœ¬ä¹¦\nfunction combineNovels(novels) {\n    return novels.filter(novel => {\n        //å•æœ¬ç›´æ¥è§£æä¸ºä¸€æœ¬ä¹¦\n        if (novel.seriesId === undefined || novel.seriesId === null) {\n            return true\n        }\n\n        //é›†åˆä¸­æ²¡æœ‰è¯¥ç³»åˆ—è§£æä¸ºä¸€æœ¬ä¹¦\n        if (!seriesSet.has(novel.seriesId)) {\n            seriesSet.add(novel.seriesId)\n            return true\n        }\n\n        return false\n    })\n}\n\n//å¤„ç†novelsåˆ—è¡¨\n//æŸ¥è¯¢ä½œè€…\nfunction handNovels(novels) {\n    novels.forEach(novel => {\n        if (novel.tags === undefined || novel.tags === null) {\n            novel.tags = []\n        }\n\n        if (novel.seriesId === undefined || novel.seriesId === null) {\n            novel.tags.unshift(\"å•æœ¬\")\n        } else {\n            let userAllWorks = getAjaxJson(util.urlUserAllWorks(novel.userId)).body\n            for (let series of userAllWorks.novelSeries) {\n                if (series.id === novel.seriesId) {\n                    // let series = getAjaxJson(util.urlSeries(novel.seriesId)).body\n                    novel.textCount = series.publishedTotalCharacterCount\n                    novel.url = series.cover.urls[\"480mw\"]\n                    novel.title = series.title\n                    novel.tags = series.tags\n                    novel.description = series.caption\n\n                    // å‘é€è¯·æ±‚è·å–ç¬¬ä¸€ç«  è·å–æ ‡ç­¾ä¸ç®€ä»‹\n                    if (novel.tags.length === 0 || novel.description === \"\") {\n                        let firstNovel = getAjaxJson(util.urlNovelDetailed(series.firstNovelId)).body\n                        if (novel.tags.length === 0) {\n                            novel.tags = firstNovel.tags.tags.map(item => item.tag)\n                        }\n\n                        if (novel.description === \"\") {\n                            novel.description = firstNovel.description\n                        }\n                    }\n\n                    novel.tags.unshift(\"é•¿ç¯‡\")\n                    break\n                }\n            }\n        }\n    })\n    util.debugFunc(() => {\n        java.log(`å¤„ç†å°è¯´å®Œæˆ`)\n    })\n    return novels\n}\n\nfunction isLogin() {\n    let cookie = String(java.getCookie(\"https://www.pixiv.net/\", null))\n    return typeof cookie === \"string\" && cookie !== \"\"\n}\n\nfunction getUserNovels(username) {\n    if (!isLogin()) {\n        return []\n    }\n\n    let html = java.ajax(util.urlSearchUser(username))\n    // java.log(html)\n    // ä»…åŒ¹é…æœ‰æŠ•ç¨¿ä½œå“çš„ç”¨æˆ·\n    let match = html.match(new RegExp(\"/users/\\\\d+/novels\"))\n    if (match === null || match.length === 0) {\n        return []\n    }\n\n    let regNumber = new RegExp(\"\\\\d+\")\n    let uidList = match.map(v => {\n        return v.match(regNumber)[0]\n    })\n\n    // ä»…é™3ä¸ªä½œè€…\n    if (uidList.length >= 3) {\n        uidList.length = 3\n    }\n\n    let novels = []\n    let page = Number(java.get(\"page\"))\n\n    uidList.forEach(id => {\n        let r = getAjaxJson(util.urlUserAllWorks(id))\n        let novelsId = Object.keys(r.body.novels).reverse().slice((page - 1) * 20, page * 20)\n        let url = util.urlUserNovels(id, novelsId)\n        util.debugFunc(() => {\n            java.log(`å‘é€è·å–ä½œè€…å°è¯´çš„Ajaxè¯·æ±‚:${url}`)\n        })\n        let userNovels = getWebviewJson(url, html => {\n            return (html.match(new RegExp(\">\\\\{.*?}<\"))[0].replace(\">\", \"\").replace(\"<\", \"\"))\n        }).body\n        // è·å–å¯¹åº”çš„å°è¯´ è¯¥åºåˆ—æ˜¯æŒ‰ç…§idæ’åº\n        // åè½¬ä»¥æŒ‰ç…§æ›´æ–°æ—¶é—´æ’åº\n        novels = novels.concat(Object.values(userNovels).reverse())\n    })\n\n\n    util.debugFunc(() => {\n        java.log(`è·å–ç”¨æˆ·æœç´¢å°è¯´ç»“æŸ`)\n    })\n    return novels\n}\n\n(() => {\n    //ä½œè€… TAG ä¹¦åéƒ½è¦æ”¯æŒ\n    let resp = JSON.parse(result);\n    let novelsList = getUserNovels(String(java.get(\"key\")))\n    novelsList = novelsList.concat(resp.body.novel.data)\n    return util.formatNovels(handNovels(combineNovels(novelsList)))\n})();",
            "bookUrl": "detailedUrl",
            "coverUrl": "coverUrl",
            "intro": "description",
            "kind": "tags",
            "lastChapter": "latestChapter",
            "name": "title",
            "wordCount": "textCount"
        },
        "ruleToc": {
            "chapterList": "@js:\n\nvar util = objParse(String(java.get(\"util\")))\n\nfunction objParse(obj) {\n    return JSON.parse(obj, (n, v) => {\n        if (typeof v == \"string\" && v.match(\"()\")) {\n            return eval(`(${v})`)\n        }\n        return v;\n    })\n}\n\nfunction seriesHandler(res) {\n    const limit = 30\n    let returnList = [];\n    let seriesID = res.seriesNavData.seriesId\n    let allChaptersCount = (() => {\n        let result = util.cacheGetAndSet(util.urlSeries(seriesID), () => {\n            return util.getAjaxJson(util.urlSeries(seriesID))\n        }).body.total\n        util.debugFunc(() => {\n            java.log(`æœ¬ç›®å½•ä¸€å…±æœ‰:${result} ç« èŠ‚`);\n        })\n        return result;\n    })();\n\n    //å‘é€è¯·æ±‚è·å¾—ç›¸åº”æ•°é‡çš„ç›®å½•åˆ—è¡¨\n    function sendAjaxForGetChapters(lastIndex) {\n        let url = util.urlSeriesNovels(seriesID, limit, lastIndex)\n        res = util.cacheGetAndSet(url, () => {\n            return util.getAjaxJson(url)\n        })\n        res = res.body.page.seriesContents\n        res.forEach(v => {\n            v.chapterUrl = util.urlNovelDetailed(v.id)\n        })\n        return res;\n    }\n\n    //é€»è¾‘æ§åˆ¶è€… ä¹Ÿå°±æ˜¯ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ä¸¤ä¸ªå‡½æ•°æ¥åšå¯¹åº”åŠŸèƒ½\n    //è¦çˆ¬å–çš„æ€»æ¬¡æ•°\n    let max = (allChaptersCount / limit) + 1\n    for (let i = 0; i < max; i++) {\n        //java.log(\"içš„å€¼:\"+i)\n        let list = sendAjaxForGetChapters(i * limit);\n        //å–å‡ºæ¯ä¸ªå€¼\n        returnList = returnList.concat(list)\n    }\n    return returnList\n}\n\nfunction aloneHandler() {\n    return [{title: book.name, chapterUrl: baseUrl}]\n}\n\n(() => {\n    let res = JSON.parse(result).body\n    if (res.seriesNavData === null || res.seriesNavData === undefined) {\n        return aloneHandler()\n    }\n    return seriesHandler(res)\n})()",
            "chapterName": "title",
            "chapterUrl": "chapterUrl"
        },
        "searchUrl": "@js:\njava.put(\"page\",page);java.put(\"key\",key);\n`https://www.pixiv.net/ajax/search/novels/${encodeURI(key)}?word=${encodeURI(key)}&order=date_d&mode=all&p=${page}&s_mode=s_tag&lang=zh`;",
        "weight": 0
    }
]